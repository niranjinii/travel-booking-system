<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/styles/admin-dashboard.css" />

    <style>
      /* Ensure chart is visible */
      .chart-container {
        width: 100%;
        height: 350px;
      }
      #revenueChart {
        width: 100% !important;
        height: 100% !important;
      }
    </style>
  </head>

  <body>
    <div class="admin-wrapper">

      <div class="admin-header">
        <div class="admin-info">
          <h1>Welcome, <%= user.name %></h1>
          <p>Admin Dashboard</p>
        </div>

        <form action="/logout" method="POST" class="logout-form">
          <button class="logout-btn">
            <i class="bi bi-door-closed"></i> Logout
          </button>
        </form>
      </div>

      <!-- TABS -->
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="audit">Payment Audit Log</button>
      </div>

      <!-- === OVERVIEW TAB === -->
      <div id="overview" class="tab-content active">

        <div class="stats-section">
          <div class="stat-card">
            <i class="bi bi-people stat-icon"></i>
            <h3>Total Users</h3>
            <p><%= stats.userCount %></p>
          </div>

          <div class="stat-card">
            <i class="bi bi-receipt stat-icon"></i>
            <h3>Total Bookings</h3>
            <p><%= stats.bookingCount %></p>
          </div>

          <div class="stat-card">
            <i class="bi bi-briefcase stat-icon"></i>
            <h3>Total Packages</h3>
            <p><%= stats.packageCount %></p>
          </div>

          <div class="stat-card">
            <i class="bi bi-cash-coin stat-icon"></i>
            <h3>Total Revenue</h3>
            <p>₹<%= stats.totalRevenue.toLocaleString() %></p>
          </div>
        </div>

        <section class="chart-section">
          <h2>Revenue Overview</h2>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </section>

        <section class="tables-section">
          <h2>Top Spending Users</h2>
          <table class="admin-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Total Spent (₹)</th>
              </tr>
            </thead>
            <tbody>
              <% topUsers.forEach(u => { %>
              <tr>
                <td><%= u.name %></td>
                <td><%= u.total_spent %></td>
              </tr>
              <% }) %>
            </tbody>
          </table>

          <h2>Top Packages by Avg Booking Value</h2>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Package</th>
                <th>Avg Value (₹)</th>
              </tr>
            </thead>
            <tbody>
              <% avgPackages.forEach(pkg => { %>
              <tr>
                <td><%= pkg.package_name %></td>
                <td><%= pkg.avg_value ? Number(pkg.avg_value).toFixed(2) : 0 %></td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </section>

      </div>

      <!-- === AUDIT TAB === -->
      <div id="audit" class="tab-content">
        <h2>Payment Audit Log</h2>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Audit ID</th>
              <th>Payment ID</th>
              <th>Booking ID</th>
              <th>Amount (₹)</th>
              <th>Method</th>
              <th>Action</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <% paymentAudit.forEach(a => { %>
            <tr>
              <td><%= a.audit_id %></td>
              <td><%= a.payment_id %></td>
              <td><%= a.booking_id %></td>
              <td><%= a.amount %></td>
              <td><%= a.method %></td>
              <td><%= a.action_type %></td>
              <td><%= new Date(a.action_date).toLocaleString() %></td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

    </div>

    <script>
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById(btn.dataset.tab).classList.add("active");
        });
      });
    </script>

    <!-- FIXED CHART SCRIPT -->
    <script>
      let monthlyStats = <%- JSON.stringify(monthlyStats) %>;
      monthlyStats = monthlyStats.map(m => ({
        month: m.month,
        total: Number(m.total) // convert string → number
      }));

      const ctx = document.getElementById('revenueChart').getContext('2d');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthlyStats.map(d => d.month),
          datasets: [{
            label: 'Monthly Revenue (₹)',
            data: monthlyStats.map(d => d.total),
            borderColor: '#00916e',
            borderWidth: 3,
            tension: 0.3
          }]
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    </script>

  </body>
</html>
